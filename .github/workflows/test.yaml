name: Test and Build
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Icarus Verilog
        run: |
          sudo apt-get update
          sudo apt-get install -y iverilog

      - name: Run RTL simulation
        run: |
          cd test
          # Compile testbench with project source
          iverilog -g2012 -o tb.vvp ../src/project.v tb.v
          # Run simulation with fixed seed
          vvp tb.vvp +RANDOM_SEED=42
          # Check exit code
          if [ $? -eq 0 ]; then
            echo "✓ RTL simulation PASSED"
          else
            echo "✗ RTL simulation FAILED"
            exit 1
          fi

      - name: Upload test waveforms
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-waveforms
          path: test/*.vcd
          if-no-files-found: warn

  # GDS build job - runs separately and can fail without blocking tests
  gds:
    runs-on: ubuntu-latest
    needs: test # Only run if tests pass
    continue-on-error: true # Don't fail the whole workflow if GDS fails
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build GDS
        run: |
          # This would normally run the Tiny Tapeout hardening flow
          # For now, just indicate it would run here
          echo "GDS build would run here with 'make gds' or Tiny Tapeout flow"
          echo "Skipping for now as it requires full OpenLane setup"

      - name: Upload GDS artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: gds-files
          path: |
            runs/wokwi/results/final/gds/*.gds
            runs/wokwi/results/final/lef/*.lef
          if-no-files-found: warn

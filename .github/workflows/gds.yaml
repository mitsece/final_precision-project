name: GDS Build and Test

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  gds:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            iverilog \
            gtkwave \
            build-essential \
            libglu1-mesa-dev \
            freeglut3-dev
      
      - name: Cache PDK
        uses: actions/cache@v4
        with:
          path: |
            ~/.volare
            /usr/local/share/pdk
          key: ${{ runner.os }}-pdk-${{ hashFiles('**/info.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pdk-
      
      - name: Install OpenLane and PDK
        run: |
          # Install volare for PDK management
          pip install volare
          
          # Enable sky130 PDK (adjust version as needed)
          volare enable --pdk sky130 2024.11.19
      
      - name: Run RTL simulation
        run: |
          if [ -d "test" ]; then
            cd test
            make clean || true
            
            # Run with fixed seed for reproducibility
            RANDOM_SEED=42 make test || {
              echo "::error::RTL simulation failed"
              exit 1
            }
          else
            echo "::warning::No test directory found, skipping RTL tests"
          fi
      
      - name: Run GL (Gate-Level) simulation
        run: |
          if [ -d "test" ]; then
            cd test
            
            # Run GL test with fixed seed
            RANDOM_SEED=42 make test_gl || {
              echo "::error::Gate-level simulation failed"
              echo "::notice::Check timing violations and setup/hold times"
              exit 1
            }
          else
            echo "::warning::No test directory found, skipping GL tests"
          fi
        continue-on-error: false
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            test/*.vcd
            test/*.log
            test/results.xml
          if-no-files-found: warn
      
      - name: Harden design (GDS generation)
        run: |
          if [ -f "Makefile" ]; then
            make gds || {
              echo "::error::GDS generation failed"
              exit 1
            }
          else
            echo "::warning::No Makefile found for GDS generation"
          fi
        continue-on-error: false
      
      - name: Upload GDS artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: gds-files
          path: |
            runs/wokwi/results/final/gds/*.gds
            runs/wokwi/results/final/lef/*.lef
            runs/wokwi/results/final/def/*.def
            runs/wokwi/reports/**/*.rpt
          if-no-files-found: warn
      
      - name: Generate summary
        if: always()
        run: |
          echo "## GDS Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "runs/wokwi/reports/metrics.csv" ]; then
            echo "### Design Metrics" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat runs/wokwi/reports/metrics.csv >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Build completed at: $(date)" >> $GITHUB_STEP_SUMMARY

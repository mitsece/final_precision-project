name: Tiny Tapeout GDS Build

# This workflow uses Tiny Tapeout's official GDS generation flow
# For more info: https://tinytapeout.com/guides/local-hardening/

on:
  workflow_dispatch:  # Manual trigger only
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'info.yaml'

jobs:
  gds:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Build GDS using Tiny Tapeout Action
        uses: TinyTapeout/tt-gds-action@tt09
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # Tiny Tapeout will handle PDK installation and GDS generation
          # No need to manually install volare or manage PDK versions
          skip-test: false
      
      - name: Upload GDS artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: gds-files
          path: |
            runs/wokwi/results/final/gds/*.gds
            runs/wokwi/results/final/lef/*.lef
            runs/wokwi/results/final/def/*.def
            runs/wokwi/reports/**/*.rpt
          if-no-files-found: warn
      
      - name: Upload to GitHub Pages
        if: success()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./runs/wokwi/results/final
